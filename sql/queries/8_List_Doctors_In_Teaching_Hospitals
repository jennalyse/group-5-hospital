-- Drop to ensure the latest version is created and used
DROP PROCEDURE IF EXISTS ListDoctorsInTeachingHospitals;

-- Set DELIMITER to // to ensure the procedure is executed at once
DELIMITER //

-- Create the stored procedure to list doctors based in teaching hospitals accredited between 2015-2024
CREATE PROCEDURE ListDoctorsInTeachingHospitals(IN start_year INT, IN end_year INT, IN hospital_type VARCHAR(255))
BEGIN
    -- Step 1: Declare variables to store intermediate results
    DECLARE hospital_count INT DEFAULT 0;

    -- Step 2: Validate teaching hospitals accredited in the given date range
    SELECT COUNT(*) INTO hospital_count
    FROM HOSPITALS
    WHERE LOWER(type) = LOWER(hospital_type)
      AND accreditation_year BETWEEN start_year AND end_year;

    -- Step 3: If no hospitals match the criteria, return an error message
    IF hospital_count = 0 THEN
        SELECT "No teaching hospitals accredited 2015-2024 found." AS message;
    ELSE
        -- Step 4: Retrieve doctors associated with these hospitals
        SELECT d.doctor_id, d.first_name, d.second_name AS last_name
        FROM DOCTORS d
        JOIN HOSPITALS h ON d.hospital_id = h.hospital_id
        WHERE LOWER(h.type) = LOWER(hospital_type)
          AND h.accreditation_year BETWEEN start_year AND end_year;

        -- Output a message if no doctors are found
        IF ROW_COUNT() = 0 THEN
            SELECT "No doctors found in teaching hospitals accredited 2015-2024." AS message;
        ELSE
            SELECT "List of doctors at teaching hospitals accredited 2015-2024:" AS header;
        END IF;
    END IF;
END //

-- Reset DELIMITER to ;
DELIMITER ;

-- Example calls to the procedure
CALL ListDoctorsInTeachingHospitals(2015, 2024, 'Teaching');
CALL ListDoctorsInTeachingHospitals(2015, 2024, 'Nonexistent');
CALL ListDoctorsInTeachingHospitals(2010, 2014, 'Teaching');
